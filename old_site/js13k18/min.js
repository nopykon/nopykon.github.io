var shader="\nprecision lowp float;\nvarying vec4 v_rgba ;\nvarying vec2 v_uv ;\nuniform vec4 u_WHTF ;\n#ifdef VERTEX_SHADER\nattribute vec3 a_pos;\nattribute float a_rgb;\nattribute vec2 a_uv;\nuniform mat4 u_M ;\nuniform mat4 u_V ;\nuniform mat4 u_P ;\nconst vec4 tool = vec4( 1. / (256.*256.), 1. / (256.), 1., 2. );\nvoid main(){\n\tv_uv = vec2(a_uv.x,1.-a_uv.y);\n\tvec4 p = u_M*vec4(a_pos,1.);\n\tv_rgba = fract(tool.xyzw * a_rgb ) * tool.wwww;\t\n\tv_rgba.xyz *= vec3(.85+.16*sin(p.x*.1+u_WHTF.z));\n\tvec3 ls = vec3(8.,8.,8.) - p.xyz ;\n\tfloat L = max( 0., 1.-dot(ls,ls)*.01);\n\tp = u_P*u_V*p;\n\tv_rgba.w = p.z/100.;\n\tgl_Position = p;\n}\n#else\nuniform sampler2D u_D ;\nuniform sampler2D u_DM ;\nuniform vec4 u_F ;\nvoid main()\n{\n#define TEX_SZ 16.\n\tvec2 uv = v_uv - vec2(.5/TEX_SZ,.5/TEX_SZ);\n\tvec4 c = texture2D( u_D, uv );\n\tc*=v_rgba;\n\tc = clamp(c,vec4(0.),vec4(1.));\n\t//FOG\n\t//c = mix( c, u_F, v_rgba.w ) ;\n\tc.w = 1.-v_rgba.w;\n\tc = 3.*c*c - 2.*c*c*c;//s-curve\n\tc.xyz += (u_F.xyz-c.xyz)*v_rgba.w;\n\n\n\t\n#if 0// NOISE\n\t//noise\n\tvec2 co = gl_FragCoord.xy*u_WHTF.z*.001;\n    float noise = fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\tc+=noise*.0125;\n#endif\n\n\n#if 0//def DITHER\n\tconst vec4 C = vec4( 1./4., 256., 32./256., 1./32.);\n\tvec3 D = texture2D( u_DM, gl_FragCoord.xy * C.xx ).xyz * 127.5 - 4.  ;\n\tvec3 q = c.rgb*C.yyy + D*2. ;//vec3( 1./2. * D - 4. );//a_rgb*C.yyy + vec3( D ) ; \n\tc.xyz = floor ( q * C.zzz )*C.www ;\n#endif\n\t//c.xyz = floor(c.xyz*32.)/32.;\n\t//c.xyz = mix(c.xyz, normalize(c.xyz), .4);\n\t//c=floor( c*32. ) * (1./32.) ;\n\n\t//c.x=mod( gl_FragCoord.x, 4. ) ; \n\t//int i = (int)mod( gl_FragCoord.x, 4. ) ; \n\t\n\n\tgl_FragColor = c;//*.5+.5*c*c;\n\t\n}\n\n#endif\n\n",sky_shader="\nprecision lowp float;\n\nuniform mat4 u_V ;\nuniform sampler2D u_DM ;\nuniform float u_T;\n\n//varying vec3 a_o;\nvarying vec3 a_r;\n\n#ifdef VERTEX_SHADER\nattribute vec2 a_pos;\n\n\nvoid main()\n{\n\tvec4 d = u_V*vec4( a_pos.xy, -1., 0. );\n\ta_r = normalize(d.xyz);\n\n\tgl_Position = vec4(a_pos.xy,0.99999,1.);\n\n}\n#else//FRAGMENT\n\nvec2 wave(vec2 p, vec2 d){return d*cos(dot(p.xy,d)+u_T );}\nvoid main()\n{\n\n\tvec3 r = a_r;\n\tvec3 o=u_V[3].xyz;\t\n\tif( r.z < 0. )\n\t{\n\t\t//r.z = -r.z;\n\t\tvec3 N = vec3(0.,0.,1.);\n\t\tfloat s = 40./-r.z;\n\t\to.xy+=r.xy*s;\n\t\tfloat fade = 20./(20.+s*s*.01) ;\n\t\t\n\t\tN.xy += wave( o.xy, vec2(.1,.21) ) * fade ; \n\t\tN.xy += wave( o.xy, vec2(-.01,-.2) ) * fade ;\n\t\t//N.xy += vec2(.2,-.2)*cos(dot(p.xy,vec2(.2,-.2)*u_T*.1) ) * (15./(15.+.01*s*s)) ; ;\n\t\t//N.x += cos(dot(p.xy,vec2(.15,.21)*u_T) )*.1 ;\n\t\t//N.y +=sin(u.x)*.1 ;\n\t\tN = normalize(N);\n\n\t\tr = reflect( r, N );\n\t\t//r.x += sin(r.x*10.+u_T*4.)*s;\n\t\t//r.y += cos(r.x*30.+u_T*8.)*s;\n\t}\n\n\tr=normalize(r);\n\t\n\tfloat SH = 18.- o.z*.1 ;\n\tvec2 uvo = o.xy*.01;\n\tfloat s= SH/r.z;\n\n\tvec2 uv0=r.xy*s*.025 + vec2(u_T*.05);\n\tvec2 uv1=r.xy*s*.0125 + uvo ;\n\n\tvec3 c = texture2D( u_DM, uv0).xyz ;\n\n\tc += texture2D( u_DM, uv1.yx).xyz;//*dot(vec3(1.),r);\n//\tc += texture2D( u_DM, uv1.yx*.33).xyz*dot(vec3(1.),r)*.5;\n\tfloat fog = 1.-1./(1.+dot(uv1,uv1));\n\t//c = mix(c,vec3(.1,.25,.3),fog);\n\tc = mix(c,vec3(.1,.27,.3),fog);\n\n\t//sun spot\n\tfloat sdp = pow(dot(r,vec3(.5)),8.);\n\tc+=vec3(sdp);\n\t//c = c*c;\n\t//c = vec3(1.)-(vec3(1.)-c)*(vec3(1.)-c);\n\t//c = 3.*c*c - 2.*c*c*c;//s-curve\n#if 0//def DITHER\n\tconst vec4 C = vec4( 1./4., 256., 32./256., 1./32.);\n\tvec3 D = texture2D( u_DM, gl_FragCoord.xy * C.xx ).xyz * 127.5 - 4.  ;\n\tvec3 q = c.rgb*C.yyy + D*2. ;//vec3( 1./2. * D - 4. );//a_rgb*C.yyy + vec3( D ) ; \n\tc.xyz = floor ( q * C.zzz )*C.www ;\n#endif\n\n\tgl_FragColor = vec4(c.xyz,1.);\n}\n#endif\n",sqrt=Math.sqrt,abs=Math.abs,min=Math.min,max=Math.max,sin=Math.sin,cos=Math.cos,pow=Math.pow,sign=Math.sign,floor=Math.floor,round=Math.round,PI=Math.PI,TAU=2*PI,Q0=[0,0,0,0],Q1=[0,0,0,0],Q2=[0,0,0,0],Q4=[0,0,0,0],rnds=13312;function rnd(){return 32767&(rnds=(rnds<<2)+(rnds>>1)+123)}function ran(){return(255&rnd())/128-1}function clamp(r,e,t){return r<e?e:r>t?t:r}function now(){return window.performance.now()/1e3}function enow(){with(window.performance){if(now)return now()/1e3;if(webkitNow)return webkitNow()}return Date.now()/1e3}function vdot(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function vcross(r,e,t){return r[0]=e[1]*t[2]-e[2]*t[1],r[1]=e[2]*t[0]-e[0]*t[2],r[2]=e[0]*t[1]-e[1]*t[0],r}function vlerp(r,e,t,n,a){a=a||3;for(var o=0;o<a;++o)r[o]=e[o]+(t[o]-e[o])*n}function vspl4(r,e,t,n,a,o){vlerp(Q0,e,t,o),vlerp(Q1,t,n,o),vlerp(Q0,Q0,Q1,o),vlerp(Q2,n,a,o),vlerp(Q1,Q1,Q2,o),vlerp(r,Q0,Q1,o)}function vnorm(r,e,t){var n=sqrt(vdot(e,e));return n?vmul1(r,e,1/n):console.log("ZERO LEN "+t),n}function vset(r,e,t,n){return r[0]=e,r[1]=t,r[2]=n,r}function vcpy(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r}function vsub(r,e,t){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r}function vadd(r,e,t){r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2]}function vads(r,e,t,n){r[0]=e[0]+t[0]*n,r[1]=e[1]+t[1]*n,r[2]=e[2]+t[2]*n}function vmul1(r,e,t){r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t}function vmul(r,e,t){r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2]}function mcpy(r,e){for(var t=0;t<3;++t)vcpy(r[t],e[t])}function mset(r,e,t,n,a,o,v,m,s,l){vset(r[0],e,t,n),vset(r[1],a,o,v),vset(r[2],m,s,l)}function tset(r,e,t,n,a,o,v,m,s,l,g,c,i){mset(r.m,e,t,n,a,o,v,m,s,l),vset(r.p,g,c,i)}function mmulv(r,e,t){for(var n=0;n<3;++n)r[n]=e[0][n]*t[0]+e[1][n]*t[1]+e[2][n]*t[2]}function mmulv_transpose(r,e,t){for(var n=0;n<3;++n)r[n]=e[n][0]*t[0]+e[n][1]*t[1]+e[n][2]*t[2]}function tmulv(r,e,t){for(var n=e.m,a=e.p,o=0;o<3;++o)r[o]=n[0][o]*t[0]+n[1][o]*t[1]+n[2][o]*t[2]+a[o]}function tmulv_transpose(r,e,t){vsub(Q0,t,e.p),mmulv_transpose(r,e.m,Q0)}function mmul(r,e,t){for(var n=0;n<3;++n)for(var a=0;a<3;++a){r[n][a]=0;for(var o=0;o<3;++o)r[n][a]+=e[o][a]*t[n][o]}}function mmul_transpose(r,e,t){for(var n=0;n<3;++n)for(var a=0;a<3;++a){r[n][a]=0;for(var o=0;o<3;++o)r[n][a]+=e[a][o]*t[n][o]}}function tran(){return{m:[[1,0,0],[0,1,0],[0,0,1]],p:[0,0,0]}}const ID=tran();var MT=tran(),CT=tran(),IC=tran(),gl;function tpov(r,e,t){mmul_transpose(r.m,e.m,t.m),vsub(Q0,t.p,e.p),mmulv_transpose(r.p,e.m,Q0)}function mat4_set(r,e,t,n,a,o,v,m,s,l,g,c,i,_,u,d,p){r[0]=e,r[1]=t,r[2]=n,r[3]=a,r[4]=o,r[5]=v,r[6]=m,r[7]=s,r[8]=l,r[9]=g,r[10]=c,r[11]=i,r[12]=_,r[13]=u,r[14]=d,r[15]=p}function mat4_from_transform(r,e){var t=e.m,n=e.p;mat4_set(r,t[0][0],t[0][1],t[0][2],0,t[1][0],t[1][1],t[1][2],0,t[2][0],t[2][1],t[2][2],0,n[0],n[1],n[2],1)}function mat4_frustum(r,e,t,n,a,o,v){let m=1/(t-e),s=1/(a-n),l=1/(o-v);return r[0]=2*o*m,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*o*s,r[6]=0,r[7]=0,r[8]=(t+e)*m,r[9]=(a+n)*s,r[10]=(v+o)*l,r[11]=-1,r[12]=0,r[13]=0,r[14]=v*o*2*l,r[15]=0,r}function mat4_mul(r,e,t){let n=e[0],a=e[1],o=e[2],v=e[3],m=e[4],s=e[5],l=e[6],g=e[7],c=e[8],i=e[9],_=e[10],u=e[11],d=e[12],p=e[13],f=e[14],V=e[15],x=t[0],h=t[1],T=t[2],y=t[3];return r[0]=x*n+h*m+T*c+y*d,r[1]=x*a+h*s+T*i+y*p,r[2]=x*o+h*l+T*_+y*f,r[3]=x*v+h*g+T*u+y*V,x=t[4],h=t[5],T=t[6],y=t[7],r[4]=x*n+h*m+T*c+y*d,r[5]=x*a+h*s+T*i+y*p,r[6]=x*o+h*l+T*_+y*f,r[7]=x*v+h*g+T*u+y*V,x=t[8],h=t[9],T=t[10],y=t[11],r[8]=x*n+h*m+T*c+y*d,r[9]=x*a+h*s+T*i+y*p,r[10]=x*o+h*l+T*_+y*f,r[11]=x*v+h*g+T*u+y*V,x=t[12],h=t[13],T=t[14],y=t[15],r[12]=x*n+h*m+T*c+y*d,r[13]=x*a+h*s+T*i+y*p,r[14]=x*o+h*l+T*_+y*f,r[15]=x*v+h*g+T*u+y*V,r}function qset(r,e,t,n,a){return r[0]=e,r[1]=t,r[2]=n,r[3]=a,r}function qcpy(r,e){for(var t=0;t<4;++t)r[t]=e[t];return r}function qrot(r,e,t,n,a){var o=sin(a/2);qset(r,e*o,t*o,n*o,cos(a/2))}function qnorm(r,e){var t=sqrt(vdot(e,e)+e[3]*e[3]);qset(r,e[0]/t,e[1]/t,e[2]/t,e[3]/t)}function qmul(r,e,t){var n=qcpy(Q0,e),a=Q1;vcross(r,n,t),vmul1(a,n,t[3]),vadd(r,r,a),vmul1(a,t,n[3]),vadd(r,r,a),r[3]=n[3]*t[3]-vdot(n,t)}function mat_from_quat(r,e){var t=e[3],n=e[0],a=e[1],o=e[2],v=t*t,m=n*n,s=a*a,l=o*o;r[0][0]=v+m-s-l,r[0][1]=2*(n*a+t*o),r[0][2]=2*(n*o-t*a),r[1][0]=2*(n*a-t*o),r[1][1]=v-m+s-l,r[1][2]=2*(a*o+t*n),r[2][0]=2*(n*o+t*a),r[2][1]=2*(a*o-t*n),r[2][2]=v-m-s+l}var NEAR=1/256,FAR=256,tex_map=[],tex_hot=new Uint8Array([255,255,255,255]),fog=new Float32Array([.1,.25,.3,1]);function get_tex(r){if(tex_map[r])return gl.bindTexture(gl.TEXTURE_2D,tex_map[r]),tex_map[r];var e=tex_map[r]=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,e),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,tex_hot);var t=new Image;return t.onload=function(){gl.bindTexture(gl.TEXTURE_2D,e),console.log("image loaded: ",t.src,t.width,t.height),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D)},t.src=r,e}function gloc(r,e){return gl.getUniformLocation(r,e)}function aloc(r,e){return gl.getAttribLocation(r,e)}function gl_check(r){for(var e=gl.getError();e;)console.log(e,r),e=gl.getError()}function compile_shader(r,e){gl_check("pre shader compile");var t=gl.createShader(gl.VERTEX_SHADER),n=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(t,r),gl.compileShader(t),gl.getShaderParameter(t,gl.COMPILE_STATUS))if(gl.shaderSource(n,e),gl.compileShader(n),gl.getShaderParameter(n,gl.COMPILE_STATUS)){var a=gl.createProgram();if(gl.attachShader(a,t),gl.attachShader(a,n),gl.linkProgram(a),gl.getProgramParameter(a,gl.LINK_STATUS)){if(gl.validateProgram(a),gl.getProgramParameter(a,gl.VALIDATE_STATUS))return gl_check("post shader compile"),a;console.error("ERROR validating program!",gl.getProgramInfoLog(a))}else console.error("ERROR linking program!",gl.getProgramInfoLog(a))}else console.error("ERROR compiling fragment shader!",gl.getShaderInfoLog(n));else console.error("ERROR compiling vertex shader!",gl.getShaderInfoLog(t))}var VTX_MAX=6144,vtx=new Float32Array(VTX_MAX),vtx_vc=0,WHTF=new Float32Array(4),vtx_vbo=null,program,a_pos,a_rgb,a_uv,a_uv,u_M,u_V,u_P;function rgbp(r,e,t){return 256*floor(128*r)+floor(128*e)+.5*t}function vtx_cpy(r){for(var e=0;e<6;++e)vtx[vtx_vc++]=r[e]}function vtx_add(r,e,t,n,a,o,v,m){vtx[vtx_vc++]=r,vtx[vtx_vc++]=e,vtx[vtx_vc++]=t,vtx[vtx_vc++]=256*floor(128*n)+floor(128*a)+.5*o,vtx[vtx_vc++]=v,vtx[vtx_vc++]=m}var MID=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),MM=MID.slice(0),VM=MID.slice(0),PM=MID.slice(0),dmh,sky_program,sky_p,sky_m,sky_dm,sky_t,sky_buf;function vtx_init(){program=compile_shader("#define VERTEX_SHADER\n"+shader,shader),a_pos=aloc(program,"a_pos"),a_rgb=aloc(program,"a_rgb"),a_uv=aloc(program,"a_uv"),u_M=gloc(program,"u_M"),u_V=gloc(program,"u_V"),u_P=gloc(program,"u_P"),u_F=gloc(program,"u_F"),u_WHTF=gloc(program,"u_WHTF"),u_D=gloc(program,"u_D"),u_DM=gloc(program,"u_DM");var r=new Uint8Array([0,8,2,10,12,4,14,6,3,11,1,9,15,7,13,5]),e=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,e),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,4,4,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,r),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),dmh=e,gl.useProgram(program),gl.uniform1i(u_D,0),gl.uniform1i(u_DM,1),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,dmh),gl.activeTexture(gl.TEXTURE0),vtx_vbo=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,vtx_vbo),gl.bufferData(gl.ARRAY_BUFFER,vtx,gl.DYNAMIC_DRAW)}function vtx_draw(r){gl.bufferSubData(gl.ARRAY_BUFFER,0,vtx.slice(0,vtx_vc)),gl.drawArrays(r,0,vtx_vc/6|0),vtx_vc=0}function vtx_add2(r,e){vtx[vtx_vc++]=r,vtx[vtx_vc++]=e}function sky_init(){sky_program=compile_shader("#define VERTEX_SHADER\n"+sky_shader,sky_shader),gl.useProgram(sky_program),sky_p=aloc(sky_program,"a_pos"),console.log("sky p = ",sky_p),sky_m=gloc(sky_program,"u_V"),sky_dm=gloc(sky_program,"u_DM"),sky_t=gloc(sky_program,"u_T"),gl.uniform1i(sky_dm,0),sky_buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,sky_buf),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),gl.STATIC_DRAW)}for(var NSH=4,NSZ=1<<NSH,NSA=NSZ-1,noise=[],i=0;i<NSZ*NSZ;++i)noise[i]=.5*ran()+.5;function seamless(r,e,t,n){for(var a=0;a<e;++a)for(var o=0;o<t;++o)for(var v=0;v<n;++v){const m=r[(a*e+o)*n+v],s=(r[(a*e+e-1-o)*n+v]-m)*(t-o)/(2*(t+2));r[(a*e+o)*n+v]+=s,r[(a*e+e-1-o)*n+v]-=s}for(a=0;a<t;++a)for(o=0;o<e;++o)for(v=0;v<n;++v){const m=r[(a*e+o)*n+v],s=(r[((e-a-1)*e+o)*n+v]-m)*(t-a)/(2*(t+2));r[(a*e+o)*n+v]+=s,r[((e-a-1)*e+o)*n+v]-=s}}function smp(r,e){var t=floor(1e5+r*NSZ)&NSA,n=floor(1e5+e*NSZ)&NSA,a=(1e5+r*NSZ)%1,o=(1e5+e*NSZ)%1,v=noise[((n&NSA)<<NSH)+(t&NSA)],m=noise[((n&NSA)<<NSH)+(t+1&NSA)],s=noise[((n+1&NSA)<<NSH)+(t&NSA)],l=v+(m-v)*a;return l+(s+(noise[((n+1&NSA)<<NSH)+(t+1&NSA)]-s)*a-l)*o}seamless(noise,NSZ,NSZ>>2,1);for(var tex_gen=new Uint32Array(16384),y=0;y<128;++y)for(var x=0;x<128;++x){var r=.25*smp(.071*y,.071*-x)+.25*smp(.171*x,.141*-y)+.25*smp(.471*y,.141*+x)+.25*smp(.01*x,.001*+y);r=clamp(256*r|0,0,255),tex_gen[128*y+x]=r<<24|r<<16|r<<8|255}function clip_poly(r,e){}function gen(){}function msd(r){buttons[r.button]=1}function msu(r){buttons[r.button]=0}var mx=0,my=0,keys=[],buttons=[],onkeyup,onkeydown;function key(r){return keys[r]?keys[r]:0}function key(r){return keys[r]?keys[r]:0}function but(r){return buttons[r]?buttons[r]:0}var default_keys=[27,8,9,13,32,37,38,39,40,16,17,18,87],SHIFT=16,CTRL=17,ALT=18,SPACE=32,RETURN=13,ESCAPE=27,LEFT=37,RIGHT=39,DOWN=40,UP=38,KA=65,KD=68,KS=83,KW=87,KQ=81,KE=69,KR=82,KG=71,KH=72,KJ=74,KL=76,KM=77,KK=75,KI=73,KU=85,KO=79,KC=67,KF=70,KZ=90,KX=88;function mousemove(r){mx=r.clientX*cv.width/window.innerWidth,my=(window.innerHeight-r.clientY)*cv.height/window.innerHeight}document.addEventListener("mousemove",mousemove,!1),document.addEventListener("mousedown",msd,!1),document.addEventListener("mouseup",msu,!1);var focus=1;function mouse(r){mx+=r.movementX||r.mozMovementX||0,my+=r.movementY||r.mozMovementY||0}function kbd(r){default_keys.indexOf(r.keyCode)>-1&&r.preventDefault(),!keys[r.keyCode]&&onkeydown&&onkeydown(r.keyCode),keys[r.keyCode]=1}function kbu(r){default_keys.indexOf(r.keyCode)>-1&&r.preventDefault(),keys[r.keyCode]&&onkeyup&&onkeyup(r.keyCode),keys[r.keyCode]=0}window.onfocus=function(){focus=!0},window.onblur=function(){for(focus=!1,i=0;i<keys.length;++i)keys[i]=0;for(i=0;i<buttons.length;++i)buttons[i]=0},window.addEventListener("gamepaddisconnected",function(r){console.log("Gamepad disconnected from index %d: %s",r.gamepad.index,r.gamepad.id)}),window.addEventListener("gamepadconnected",function(r){var e=navigator.getGamepads()[r.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.index,e.id,e.buttons.length,e.axes.length)});var gamepads={},gamepads;function gamepadHandler(r,e){var t=r.gamepad;e?gamepads[t.index]=t:delete gamepads[t.index]}window.addEventListener("gamepadconnected",function(r){gamepadHandler(r,!0)},!1),window.addEventListener("gamepaddisconnected",function(r){gamepadHandler(r,!1)},!1);var bacc=0,bleft=0,brite=0,gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[],V0=[0,0,0,0],V1=[0,0,0,0],V2=[0,0,0,0],V3=[0,0,0,0],V4=[0,0,0,0],V5=[0,0,0,0],V6=[0,0,0,0],VV=[V0,V1,V2,V3,V4,V5,V6],SCALE=7;function cpm(r,e,t,n){var a=V0;return vnorm(a,vcross(a,e,t)),n&&(vnorm(t,vcross(t,a,e)),a[0]=a[0]*cos(n)+t[0]*sin(n),a[2]=a[2]*cos(n)+t[2]*sin(n)),vmul1(r,r,SCALE),vmul1(e,e,SCALE),{p:r,d:e,x:vcpy(t,a),si:0}}var cp=[cpm([2,-2,.5],[1,0,0],[0,0,1]),cpm([4,-2,1],[1,0,0],[0,0,1]),cpm([7,0,1],[0,1,0],[0,0,1],PI/3),cpm([5,2,1],[-1,1,0],[0,0,1],0),cpm([1,8,1],[0,1,0],[0,0,1]),cpm([1,12,1],[0,.25,0],[-1,0,0]),cpm([1,14,1],[0,.25,0],[0,0,-1]),cpm([1,16,1],[0,.25,0],[1,0,0]),cpm([1,20,1],[0,2,0],[0,0,1]),cpm([0,22,2],[-1,0,0],[0,-1,0]),cpm([-1,20,.5],[0,-2,0],[0,0,1]),cpm([-1,15,1.5],[0,-1,0],[0,0,1]),cpm([-1,13,.5],[0,-1,0],[0,0,1]),cpm([-1,10,0],[0,-1,0],[0,0,1],0),cpm([-3,3,0],[-2,-1,0],[0,0,1],-.4),cpm([-8,-1,0],[0,-3,0],[0,0,1],PI/3),cpm([-4,-2.4,0],[1,0,0],[0,0,1]),cpm([0,-2.4,0],[1,0,0],[0,0,1]),cpm([0,-2.2,1.5],[-1,0,0],[0,0,-1]),cpm([0,-2,0],[1,0,0],[0,0,1])],seg=[],hm,hm_n,hm_P;function splinelen(r,e,t,n,a,o){for(var v=vcpy(V4,r),m=V5,s=0,l=0;l<a;++l,vcpy(v,m))vspl4(m,r,e,t,n,(l+1)/a),vsub(v,m,v),s+=sqrt(vdot(v,v));return s}function cp_gen(){for(var r=[0,0,1],e=[0,-1,0],t=[1,0,0],n=cp[cp.length-1],a=cp[0],o=0;o<cp.length;n=a,a=cp[++o]){n.si=seg.length;const o=1;vads(V1,n.p,n.d,o),vads(V2,a.p,a.d,-o);var v=splinelen(n.p,V1,V2,a.p,100,1);for(var m=floor(v/1),s=v/m,l=vcpy(V0,n.p),g=V3,c=0,i=0;c<m;++c,vcpy(l,g)){for(var _=1/m,u=i+_,d=0;d<100;++d)vspl4(g,n.p,V1,V2,a.p,u),vsub(g,g,l),u=i+(_*=s/sqrt(vdot(g,g)));vspl4(g,n.p,V1,V2,a.p,u),i=u,vsub(t,g,l),vnorm(t,t),vlerp(e,n.x,a.x,u),vcross(r,e,t),vnorm(r,r),vcross(e,t,r),vnorm(e,e),seg[seg.length]={p:vcpy([],l),m:[[e[0],e[1],e[2]],[t[0],t[1],t[2]],[r[0],r[1],r[2]]],polys:[]}}}}function seg_gen(){const r=.35,e=[[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[-.7,0,.7],[-.7,0,.7],[-.7,0,.7],[-.7,0,.7],[-.7,0,.7],[-.7,0,.7],[.7,0,.7],[.7,0,.7],[.7,0,.7],[.7,0,.7],[.7,0,.7],[.7,0,.7]],t=[[-1,0,0],[1,0,0],[1,1,0],[-1,0,0],[1,1,0],[-1,1,0],[1,0,0],[1+r,0,+r],[1+r,1,+r],[1,0,0],[1+r,1,+r],[1,1,0],[-1-r,0,+r],[-1,0,0],[-1,1,0],[-1-r,0,+r],[-1,1,0],[-1-r,1,+r]],n=[0,0,5,0,5,2,0,0,5,2,0,2,0,0,1,0,1,2,0,0,1,2,0,2,0,0,1,0,1,2,0,0,1,2,0,2];seg_v=[],seg_P=[];for(var a=0;a<seg.length;++a)for(var o=seg[a],v=seg[(a+1)%seg.length],m=0;m<t.length;){for(var s=0;s<3;++s,++m){var l=t[m],g=l[1];vset(V0,l[0]*o.m[0][0]+l[2]*o.m[2][0]+o.p[0],l[0]*o.m[0][1]+l[2]*o.m[2][1]+o.p[1],l[0]*o.m[0][2]+l[2]*o.m[2][2]+o.p[2]),vset(V1,l[0]*v.m[0][0]+l[2]*v.m[2][0]+v.p[0],l[0]*v.m[0][1]+l[2]*v.m[2][1]+v.p[1],l[0]*v.m[0][2]+l[2]*v.m[2][2]+v.p[2]),vlerp(V0,V0,V1,g),mmulv(V2,o.m,e[m]),mmulv(V3,v.m,e[m]),vlerp(V2,V2,V3,g);var c=.53+.47*max(0,V2[2]),i=max(fog[0],c),_=max(fog[1],c),u=max(fog[2],c);a>>1&1&&(i*=.5,_*=.5),seg_v[seg_v.length]=[V0[0],V0[1],V0[2],rgbp(i,_,u),n[2*m+0],n[2*m+1]]}var d=seg_v[seg_v.length-3],p=(u=seg_v[seg_v.length-2],seg_v[seg_v.length-1]);vcross(V0,vsub(V1,u,d),vsub(V2,p,d)),vnorm(V0,V0),o.polys.push([t[m-3],t[m-2],t[m-1],[V0[0],V0[1],V0[2],-vdot(V0,d)]])}seg_vbo=gl.createBuffer(),seg_vbo||console.log("epic fail");var f=[];for(a=0;a<seg_v.length;++a)for(m=0;m<6;++m)f[f.length]=seg_v[a][m];var V=new Float32Array(f);gl.bindBuffer(gl.ARRAY_BUFFER,seg_vbo),gl.bufferData(gl.ARRAY_BUFFER,V,gl.STATIC_DRAW),console.log("len = ",V.length)}function seg_draw(){gl.bindBuffer(gl.ARRAY_BUFFER,seg_vbo),gl.vertexAttribPointer(a_pos,3,gl.FLOAT,!1,24,0),gl.vertexAttribPointer(a_rgb,1,gl.FLOAT,!1,24,12),gl.vertexAttribPointer(a_uv,2,gl.FLOAT,!1,24,16),gl.drawArrays(gl.TRIANGLES,0,seg_v.length)}function vtx_addv(r){for(var e=0;e<6;++e)vtx[vtx_vc++]=r[e]}var hm_S=32,hm_E=4,hm_buf,hm_vc,water_handle;function hmprint(){for(var r="[",e=0;e<hm_S;++e){for(var t=0;t<hm_S;++t)r+=(0|10*(4+hm[e*hm_S+t]))+",";r+="\n"}r+="]",console.log(r)}function hm_gen(){var r=hm_E,e=hm_S,t=hm_S>>1;hm=[];for(var n=0;n<e;++n)for(var a=0;a<e;++a){var o=(1-max(abs(a-t),abs(n-t))/t)*(8*smp(a/e*.1,n/e*.1)+smp(n/e*2,-a/e*2)+.25*smp(10-n/e*8,10+a/e*8)+.125*smp(a/e*16,n/e*16))-1;hm[n*e+a]=o*r}for(var v=0;v<seg.length;++v){var m=seg[v],s=m.p[0]/r+t+.5|0,l=m.p[1]/r+t+.5|0,g=1.55-1.25*m.m[2][2];if(m.m[2][2]>0)for(n=l-1;n<=l+1;++n)for(a=s-1;a<=s+1;++a){var c=hm[n*e+a];if(c&&c>m.p[2]-g){var i=s*r-e*r*.5-m.p[0],_=l*r-e*r*.5-m.p[1],u=i*i+_*_;if(u<r*r){var d=m.p[2]-g-c;hm[n*e+a]+=d/(1+.25*u)}}}}for(v=0;v<100;++v){s=1+rnd()%(e-4);var p=0;for(n=(l=1+rnd()%(e-4))-1;n<l+2;++n)for(a=s-1;a<s+2;++a){p|=(o=hm[n*e+a])<5&&o>WL-.8||o>30}o=40+(31&rnd());if(!p)for(var f=0;f<4;++f)hm[(l+(f>>1))*e+(s+(1&f))]=o}hm_P=new Array(e*e);for(n=0;n<e-1;++n)for(a=0;a<e-1;++a){var V=vset(V0,(a+0-t)*r,(n+0-t)*r,hm[(n+0)*e+(a+0)]),x=vset(V1,(a+1-t)*r,(n+0-t)*r,hm[(n+0)*e+(a+1)]),h=vset(V2,(a+1-t)*r,(n+1-t)*r,hm[(n+1)*e+(a+1)]),T=vset(V3,(a+0-t)*r,(n+1-t)*r,hm[(n+1)*e+(a+0)]);vsub(V4,x,V),vsub(V5,h,V),vcross(V6,V4,V5),vnorm(V6,V6),V6[3]=-vdot(V6,V0);var y=qcpy([],V6);vsub(V4,T,V),vcross(V6,V5,V4),vnorm(V6,V6),V6[3]=-vdot(V6,V0);var b=qcpy([],V6);hm_P[n*e+a]=[y,b]}hm_n=[];for(n=0;n<e;++n)for(a=0;a<e;++a){var E=vset(V0,0,0,1);for(l=max(n-1,0);l<=min(n,e-2);++l)for(s=max(a-1,0);s<=min(a,e-2);++s)vadd(E,E,hm_P[l*e+s][0]),vadd(E,E,hm_P[l*e+s][1]);vnorm(E,E),hm_n[n*e+a]=[E[0],E[1],E[2]]}}function hm_draw(){if(!hm_buf){for(var r=[],e=hm_E,t=hm_S,n=hm_S>>1,a=1.5,o=1.2,v=.9,m=0;m<t-1;++m)for(var s=0;s<t-1;++s){var l=hm_P[m*t+s],g=vset(V0,(s+0-n)*e,(m+0-n)*e,hm[(m+0)*t+(s+0)]),c=vset(V1,(s+1-n)*e,(m+0-n)*e,hm[(m+0)*t+(s+1)]),i=vset(V2,(s+1-n)*e,(m+1-n)*e,hm[(m+1)*t+(s+1)]),_=vset(V3,(s+0-n)*e,(m+1-n)*e,hm[(m+1)*t+(s+0)]),u=hm_n[(m+0)*t+s+0],d=hm_n[(m+0)*t+s+1],p=hm_n[(m+1)*t+s+1],f=hm_n[(m+1)*t+s+0],V=.708,x=.5+.5*vdot(vdot(E=l[0],u)>V?u:E,[.7,0,.7]),h=.5+.5*vdot(vdot(E,d)>V?d:E,[.7,0,.7]),T=.5+.5*vdot(vdot(E,p)>V?p:E,[.7,0,.7]);vsub(V5,c,g);var y=vnorm(V5,V5)/e;vsub(V5,i,c);var b=vnorm(V5,V5)/e;r[r.length]=[g[0],g[1],g[2],rgbp(x*a,x*o,x*v),0,0],r[r.length]=[c[0],c[1],c[2],rgbp(h*a,h*o,h*v),y,0],r[r.length]=[i[0],i[1],i[2],rgbp(T*a,T*o,T*v),y,b];x=.5+.5*vdot(vdot(E=l[1],u)>V?u:E,[.7,0,.7]),T=.5+.5*vdot(vdot(E,p)>V?p:E,[.7,0,.7]);var E,w=.5+.5*vdot(vdot(E,f)>V?f:E,[.7,0,.7]);vsub(V5,i,_);y=vnorm(V5,V5)/e;vsub(V5,_,g);b=vnorm(V5,V5)/e;r[r.length]=[g[0],g[1],g[2],rgbp(x*a,x*o,x*v),0,0],r[r.length]=[i[0],i[1],i[2],rgbp(T*a,T*o,T*v),y,b],r[r.length]=[_[0],_[1],_[2],rgbp(w*a,w*o,w*v),0,b]}hm_vc=r.length;for(var A=[],R=0;R<r.length;++R)for(var S=0;S<6;++S)A[6*R+S]=r[R][S];hm_buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,hm_buf),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(A),gl.STATIC_DRAW)}gl.bindBuffer(gl.ARRAY_BUFFER,hm_buf),gl.vertexAttribPointer(a_pos,3,gl.FLOAT,!1,24,0),gl.vertexAttribPointer(a_rgb,1,gl.FLOAT,!1,24,12),gl.vertexAttribPointer(a_uv,2,gl.FLOAT,!1,24,16),gl.drawArrays(gl.TRIANGLES,0,hm_vc)}function water(r,e,t){var n=.5+.249*sin(.866*(e+=t)+.5*(r+=t))+.1249*sin(-r);smp(.7*r,.7*e),smp(.8*r,.3*-e);return.75*n}const WL=-1.5;function water_gen(){if(!water_handle){var r=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,r);const m=16;for(var e=new Array(m*m*4),t=0;t<m;++t)for(var n=0;n<m;++n){var a=n/m,o=t/m,v=smp(.3*a,.3*o)+smp(.71*a+-.71*o,.71*a+.71*o)+smp(.071*a+.071*o,-.071*a+.071*o);smp(.86*a+.5*o,-.5*a+.86*o),v=clamp(v/3,0,1),e[4*(t*m+n)+0]=0|clamp(256*(.7*v+.01*ran()),0,255),e[4*(t*m+n)+1]=0|clamp(256*(.9*v+.015*ran()),0,255),e[4*(t*m+n)+2]=0|clamp(256*(1*v+.005*ran()),0,255),e[4*(t*m+n)+3]=255}seamless(e,m,m>>2,4),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,m,m,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(e)),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),water_handle=r}}var rb=[];function rb_add(){return rb[rb.length]={p:[0,0,0],m:[[1,0,0],[0,1,0],[0,0,1]],q:[0,0,0,1],v:[0,0,0],w:[0,0,0],F:[0,0,0],T:[0,0,0],hits:0}}var GRAV=25e-5;const rX=.1,rY=.15,rZ=.075;var rb_Pv=[[-rX,-rY,+rZ],[+rX,-rY,+rZ],[+rX,+rY,+rZ],[-rX,+rY,+rZ],[-rX,-rY,-rZ],[+rX,-rY,-rZ],[+rX,+rY,-rZ],[-rX,+rY,-rZ]],rb_Iv=[0,1,2,0,2,3,6,5,4,7,6,4,4,5,1,4,1,0,7,3,2,6,7,2,5,6,2,5,2,1,4,0,3,7,4,3,3,0,4,3,4,7];function rb_torque(r,e,t){for(var n=vset(Q0,0,0,0),a=1/(rX*rX+rY*rY+rZ*rZ),o=0;o<3;++o)vcross(n,e,r.m[o]),r.T[o]-=vdot(n,t)*a}function rb_impulse(r,e,t){vadd(r.F,r.F,t);for(var n=vset(Q0,0,0,0),a=1/(rX*rX+rY*rY+rZ*rZ),o=0;o<3;++o){vcross(n,e,r.m[o]);var v=vdot(n,t);r.T[o]-=v*a}}function ctri2(r,e){for(var t=e[2],n=e[0],a=0;a<3;t=n,n=e[++a]){var o=n[0]-t[0],v=n[1]-t[1];if((r[0]-t[0])*v-(r[1]-t[1])*o>0)return 0}return 1}function rb_update(){for(var i=0;i<rb.length;++i)with(rb[i]){vmul1(w,w,.995),vads(v,v,F,1),vads(w,w,T,1),hits=0,vset(F,0,0,0),vset(T,0,0,0);for(var j=0;j<3;++j)v[j]=clamp(v[j],-.3,.3),w[j]=clamp(w[j],-.1,.1);vadd(p,p,v);var qR=V0;qrot(V0,1,0,0,w[0]),qrot(V1,0,1,0,w[1]),qrot(V2,0,0,1,w[2]),qmul(V0,V0,V1),qmul(V0,V0,V2),qmul(q,q,qR),qnorm(q,q),mat_from_quat(m,q)}for(var i=0;i<rb.length;++i)for(var B=rb[i],j=0;j<rb_Pv.length;++j){var pt=V6,pt_id=rb_Pv[j],pt_f=[1,1,1,1,1,1,1,1,.01,.01,.01,.01][j];tmulv(pt,B,pt_id);for(var E=hm_E,S=hm_S,SH=hm_S>>1,ix=clamp(round(pt[0]/E+SH),1,S-2),iy=clamp(round(pt[1]/E+SH),1,S-2),y=iy-1;y<=iy;++y)for(var x=ix-1;x<=ix;++x)for(var k=0;k<2;++k){var P=hm_P[y*S+x][k],s=vdot(P,pt)+P[3],MAG=0;if(!(s>MAG)&&(vset(V0,(x-SH)*E,(y-SH)*E,hm[y*S+x]),k<1?(vset(V1,(x+1-SH)*E,(y-SH)*E,hm[y*S+x+1]),vset(V2,(x+1-SH)*E,(y+1-SH)*E,hm[(y+1)*S+x+1])):(vset(V1,(x+1-SH)*E,(y+1-SH)*E,hm[(y+1)*S+x+1]),vset(V2,(x-SH)*E,(y+1-SH)*E,hm[(y+1)*S+x])),ctri2(pt,VV,P))){vcross(V1,B.w,pt_id),mmulv(V2,B.m,V1),vadd(V2,V2,B.v);var dp=vdot(P,V2);vads(V2,V2,P,-dp),vmul1(V2,V2,-.01),vmul1(V0,P,10*s*min(-5e-4,dp)),vadd(V0,V0,V2),vmul1(V0,V0,pt_f),vsub(pt,pt,B.p),rb_impulse(B,pt,V0),++B.hits}}}}var tmp=tran();function rb_draw2(ST){for(var B=tmp,ws=V4,qs=V3,i=0;i<rb.length;++i)with(rb[i]){vads(B.p,p,v,ST),qcpy(qs,q);var qR=V0;qrot(V0,1,0,0,w[0]*ST),qrot(V1,0,1,0,w[1]*ST),qrot(V2,0,0,1,w[2]*ST),qmul(V0,V0,V1),qmul(V0,V0,V2),qmul(qs,qs,qR),qnorm(qs,qs),mat_from_quat(B.m,qs);for(var a=V3,b=V4,c=V5,j=0;j<rb_Iv.length;j+=3){tmulv(a,B,rb_Pv[rb_Iv[j+0]]),tmulv(b,B,rb_Pv[rb_Iv[j+1]]),tmulv(c,B,rb_Pv[rb_Iv[j+2]]),vsub(V0,b,a),vsub(V1,c,a),vcross(V2,V0,V1),vnorm(V2,V2,"rb draw2");var L=.7+.3*V2[2];vtx_add(a[0],a[1],a[2],L,L,L,0,0),vtx_add(b[0],b[1],b[2],L,L,L,0,0),vtx_add(c[0],c[1],c[2],L,L,L,0,0)}}vtx_draw(gl.TRIANGLES)}var lks=0,lkst=0,hov=0,check=0,ag_on=1,hpol=0,ag_S=tran();function ag_reset(){var r=seg[check];lks=check,vads(ag.p,r.p,r.m[2],.6),vset(ag.v,0,0,0),vset(ag.w,0,0,0),vset(ag.F,0,0,0),vset(ag.T,0,0,0),mcpy(ag_S.m,r.m),vcpy(ag_S.p,r.p);var e=r.m[1];qrot(ag.q,0,0,1,Math.atan2(-e[0],e[1])),mat_from_quat(ag.m,ag.q)}var button_last=[],ag_lean=0,ag_tilt=0,ac_smooth=0,ax_smooth=0,az_smooth=0;function ag_ag(r){var e=ag_S,t=vdot(e.m[2],r.p)-vdot(e.m[2],e.p)-.3,n=vdot(e.m[2],r.v),a=vdot(e.m[2],r.m[0]),o=vdot(e.m[2],r.m[1]);vdot(e.m[2],r.m[2]);if(t<0){a*=200*min(-.001,-a*r.w[1]),o*=200*min(-.001,-o*r.w[0]);var v=vcpy(V2,r.m[2]);vmul1(v,v,cos(ag_lean)),vads(v,v,r.m[0],sin(ag_lean));var m=1-vdot(v,e.m[2]);vmul1(V1,e.m[2],.01*m),rb_torque(r,v,V1),vads(r.T,r.T,r.w,-.051),vmul1(V1,e.m[2],5*t*min(n,-5e-4)),vadd(r.F,r.F,V1)}}function ag2(r){}function ag_control(r){if(lks<0)return void(r.F[2]-=GRAV);var e=ag_S;ag_ag(r);var t=key(KZ),n=key(DOWN)-key(UP),a=key(LEFT)-key(RIGHT);a=az_smooth=a?az_smooth+.1*(a-az_smooth):0,t=ac_smooth=t?ac_smooth+.1*(t-ac_smooth):0,(n=ax_smooth=n?ax_smooth+.1*(n-ax_smooth):0)&&(r.T[0]+=5e-4*n,r.T[0]-=.05*r.w[0]);t=clamp(t,0,1),vads(r.F,r.F,r.m[1],1e-4*t);var o=vdot(e.m[2],r.p)-vdot(e.m[2],e.p);if(o>.5)r.F[2]-=GRAV;else{var v=max(0,o-.6)/.6;vads(r.F,r.F,e.m[2],-GRAV*(1-v)),r.F[2]-=GRAV*v;for(var m=0,s=0;s<3;++s){var l=vdot(e.m[2],r.m[s]);r.T[s]+=l*a*5e-4,r.T[s]-=abs(l)*r.w[s]*.05,m+=l*r.w[s]}m=clamp(50*m,-PI/3,PI/3),ag_lean+=.01*(az_smooth*PI/4-ag_lean<0?-1:1);var g=vdot(r.v,r.v),c=sqrt(g);if(c){vmul1(V0,r.v,1/c);var i=vdot(r.m[0],V0),_=vdot(r.m[2],V0);vmul1(V2,r.m[0],-i*g*.25*.5),vmul1(V3,r.m[2],-_*g*.25),vadd(V2,V2,V3);l=vdot(V2,e.m[2]);vads(V2,V2,e.m[2],.7*-l),vadd(r.F,r.F,V2)}}}function ag_map(r){res=-1;for(var e=10,t=lks-10;t<=lks+10;++t){var n=seg[(t+seg.length)%seg.length],a=seg[(t+seg.length+1)%seg.length],o=vcpy(V0,n.m[1]),v=vcpy(V1,a.m[1]),m=vdot(r.p,o)-vdot(n.p,o),s=vdot(r.p,v)-vdot(a.p,v);if(!(m<0||s>0)){var l=vdot(r.p,n.m[0])-vdot(n.p,n.m[0]),g=vdot(r.p,n.m[2])-vdot(n.p,n.m[2]);if(!(l>1.4||l<-1.4||g>e||g<0)){e=g,res=(t+seg.length)%seg.length;var c=m/(m-s);mlerp(ag_S.m,n.m,a.m,c),vlerp(ag_S.p,n.p,a.p,c)}}}if(res<0)return lks=-1,void(tick-lkst>10*pHz&&ag_reset());lkst=tick,lks=(res+seg.length+seg.length)%seg.length,seg[lks].m[2][2]>.99&&(check=lks);for(var i=0;i<rb_Pv.length;++i){var _=rb_Pv[i],u=V6;tmulv(u,ag,_);for(t=res-2;t<=res+2;++t){n=seg[(t+seg.length)%seg.length];for(var d=0;d<n.polys.length;++d){var p=n.polys[d][3],f=vdot(p,u)+p[3];if(!(f>=0||f<-.1)&&(tmulv_transpose(V4,n,u),ctri2(V4,n.polys[d]))){vcross(V1,r.w,_),mmulv(V2,r.m,V1),vadd(V2,V2,r.v);var V=vdot(p,V2);vads(V2,V2,p,-V),vmul1(V2,V2,vdot(V2,V2)>5e-6?-1e-4:-.25);abs(vdot(n.m[0],p));vads(r.F,r.F,r.v,-.01),vmul1(V0,p,20*f*min(-5e-4,V)),vadd(V0,V0,V2),vsub(u,u,r.p),rb_impulse(r,u,V0),++r.hits}}}}}var cam={p:[0,-2,.1],mp:[[1,0,0],[1,0,0],[1,0,0]],m:[[1,0,0],[1,0,0],[1,0,0]],v:[0,0,0],pitch:0,pitchv:.5,yaw:0,yawv:0,roll:0,rollv:0,zoom:1,zoomv:0,mode:1,segment:0,segf:0},ag=rb_add();function mlerp(r,e,t,n){for(var a=0;a<3;++a)vlerp(r[a],e[a],t[a],n),vnorm(r[a],r[a])}function game_init(){vtx_init(),sky_init(),cp_gen(),seg_gen(),hm_gen(),water_gen(),lks=450,lkst=tick,vcpy(ag.p,seg[lks].p);var r=seg[lks].m[1];qrot(ag.q,0,0,1,Math.atan2(-r[0],r[1])),mat_from_quat(ag.m,ag.q),ag.p[2]+=.4,vset(ag.v,0,0,1e-6)}function cr(){if(0===cr.sleep)switch(cr.pos++){default:case 0:return}else--cr.sleep}function game_update(){with(cr(),ag_map(ag),rb_update(),cam)switch(zoom+=zoomv,zoomv=((key(KX)?.25:.75)-zoom)/3,ag_control(ag),lks<0?2:mode){case 0:vadd(p,p,v),tmulv(v,ag,vset(V0,0,.15,.075)),vsub(v,v,p),mcpy(mp,m),vcpy(m[0],ag.m[0]),vcpy(m[1],ag.m[2]),vmul1(m[2],ag.m[1],-1);break;case 1:var s=ag_S,zs=vdot(s.m[2],ag.p)-vdot(s.m[2],s.p),t=clamp(1-10*(zs-.3),0,1),Z=V4;vmul1(Z,s.m[2],t),vads(Z,Z,ag.m[2],1-t),vnorm(Z,Z),vadd(p,p,v),mcpy(mp,m),vcross(V0,ag.m[1],Z),vnorm(V0,V0),vcross(V1,V0,Z),vnorm(V1,V1),mset(m,V0[0],V0[1],V0[2],Z[0],Z[1],Z[2],V1[0],V1[1],V1[2]),vads(v,ag.p,Z,.2),vads(v,v,V1,.65);var xs=vdot(s.m[0],p)-vdot(s.m[0],s.p);vads(v,v,s.m[0],.15*-xs),vsub(v,v,p);break;case 2:vset(v,0,0,.001),vsub(V0,ag.p,p);var s=vnorm(V0,V0);zoomv=.05*((key(KX)?1:1/(1+s))-zoom),vcross(V2,V0,vset(V1,0,0,1)),vnorm(V2,V2),vcross(V1,V2,V0),mcpy(mp,m),mset(m,V2[0],V2[1],V2[2],V1[0],V1[1],V1[2],-V0[0],-V0[1],-V0[2]);break;case 3:vadd(p,p,v),vmul1(v,v,.9);var T=vset(V1,ag.p[0],ag.p[1],ag.p[2]+2);vads(T,T,ag_S.m[2],.25),vsub(V0,T,p);var ss=sqrt(vdot(V0,V0)),des=3.45;if(ss>des){var f=ss-des;vmul1(V0,V0,1/ss),vmul1(v,V0,.7*f)}else if(ss<des){var f=des-ss;ss?(vmul1(V0,V0,1/ss),vmul1(v,V0,.7*-f)):vcpy(p,T)}vsub(V0,ag.p,p);var s=vnorm(V0,V0);zoomv=.05*((key(KX)?1/(1+s):.5)-zoom),vcross(V2,V0,lks<0?vset(V1,0,0,1):ag_S.m[2]),vnorm(V2,V2),vcross(V1,V2,V0),mcpy(mp,m),mset(m,V2[0],V2[1],V2[2],V1[0],V1[1],V1[2],-V0[0],-V0[1],-V0[2])}}function game_render(r){gl.viewport(0,0,cv.width,cv.height),gl.clear(gl.DEPTH_BUFFER_BIT),vads(CT.p,cam.p,cam.v,r),mlerp(CT.m,cam.mp,cam.m,r),tpov(IC,CT,ID),ZOOM=cam.zoom+cam.zoomv*r,gl.useProgram(program),gl.enableVertexAttribArray(a_pos),gl.enableVertexAttribArray(a_rgb),gl.enableVertexAttribArray(a_uv),mat4_from_transform(VM,IC),mat4_from_transform(MM,MT),mat4_set(MM,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var e=ZOOM*NEAR,t=cv.width/cv.height*e;mat4_frustum(PM,-t,t,-e,e,NEAR,FAR),gl.useProgram(program),gl.uniformMatrix4fv(u_M,!1,MM),gl.uniformMatrix4fv(u_V,!1,VM),gl.uniformMatrix4fv(u_P,!1,PM),qset(WHTF,cv.width,cv.height,now(),0),gl.uniform4fv(u_WHTF,WHTF),gl.uniform4fv(u_F,fog),gl.enable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.bindTexture(gl.TEXTURE_2D,get_tex("tex.png")),seg_draw(),gl.bindTexture(gl.TEXTURE_2D,water_handle),hm_draw(),gl.bindBuffer(gl.ARRAY_BUFFER,vtx_vbo),gl.vertexAttribPointer(a_pos,3,gl.FLOAT,!1,24,0),gl.vertexAttribPointer(a_rgb,1,gl.FLOAT,!1,24,12),gl.vertexAttribPointer(a_uv,2,gl.FLOAT,!1,24,16),gl.bindTexture(gl.TEXTURE_2D,get_tex("bad")),(lks<0||0!=cam.mode)&&rb_draw2(r),gl.disable(gl.DEPTH_TEST),gl.bindTexture(gl.TEXTURE_2D,get_tex("bad")),vcpy(V0,CT.m[2]);var n=sqrt(vdot(V0,V0));if(n>0){vmul1(V0,V0,1/n),gl.bindTexture(gl.TEXTURE_2D,get_tex("bad"));var a=cv.height/cv.width,o=V0[0],v=-V0[1],m=-CT.p[0],s=-CT.p[1],l=Math.atan2(CT.m[0][1],CT.m[0][0]),g=(o=sin(l),(v=cos(l))*m+o*s),c=-o*m+v*s;mat4_set(MM,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),mat4_set(VM,v,-o,0,0,o,v,0,0,0,0,1,0,g,c,0,1),mat4_set(PM,.005*a,0,0,0,0,.005,0,0,0,0,0,0,-.75,-.75,0,1),gl.uniformMatrix4fv(u_M,!1,MM),gl.uniformMatrix4fv(u_V,!1,VM),gl.uniformMatrix4fv(u_P,!1,PM),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE_MINUS_DST_COLOR,gl.ZERO);for(var i=0;i<seg.length;++i){var _=seg[i];vtx_add(_.p[0],_.p[1],_.p[2],1,1,1,0,0)}gl.disable(gl.DEPTH_TEST),vtx_draw(gl.LINE_LOOP),gl.disable(gl.BLEND);v=cos(TAU/6),o=sin(TAU/6);var u=2,d=0;for(i=0;i<=6;++i){vtx_add(cam.p[0]+u,cam.p[1]+d,0,1,0,0,0,0);c=u*o+d*v;u=g=u*v-d*o,d=c,vtx_add(cam.p[0]+u,cam.p[1]+d,0,1,0,0,0,0)}vtx_add(cam.p[0],cam.p[1],0,1,0,0,0,0),vtx_add(cam.p[0]-3*CT.m[2][0],cam.p[1]-3*CT.m[2][1],0,1,0,0,0,0),gl.bindTexture(gl.TEXTURE_2D,get_tex("bad")),gl.disable(gl.DEPTH_TEST),vtx_draw(gl.LINES)}gl.disableVertexAttribArray(a_pos),gl.disableVertexAttribArray(a_rgb),gl.disableVertexAttribArray(a_uv),gl.enable(gl.DEPTH_TEST),gl.useProgram(sky_program),gl.bindBuffer(gl.ARRAY_BUFFER,sky_buf);t=cv.width/cv.height;vmul1(V0,CT.m[0],t*ZOOM),vmul1(V1,CT.m[1],ZOOM),vmul1(V2,CT.m[2],1),mat4_set(VM,V0[0],V0[1],V0[2],0,V1[0],V1[1],V1[2],0,V2[0],V2[1],V2[2],0,CT.p[0],CT.p[1],CT.p[2],1),gl.uniformMatrix4fv(sky_m,!1,VM),gl.uniform1f(sky_t,now()),gl.bindTexture(gl.TEXTURE_2D,water_handle),gl.vertexAttribPointer(sky_p,2,gl.FLOAT,!1,8,0),gl.enableVertexAttribArray(sky_p),gl.drawArrays(gl.TRIANGLE_FAN,0,4),gl.disableVertexAttribArray(sky_p)}onkeydown=function(r){switch(r){default:return;case KC:return void(cam.mode=(cam.mode+1)%4);case KR:return void ag_reset()}},cr.sleep=0,cr.pos=0;var cv=document.getElementById("cv");function tmp_update(){}function tmp_render(){gl.clearColor(.01,sin(now())+1,.01,1),gl.clear(gl.COLOR_BUFFER_BIT)}var update,render,tick=0,frame=0,last_t=now(),tii=0,pHz=240;function r_update(){if(focus){var r=1/pHz,e=now(),t=e-last_t,n=floor(t/r),a=t-n*r;if(n>0)for(last_t=e-a,n=min(n,3);n--;++tick)update();render(a*pHz),++frame}}var log_s="";function log(){for(var r=0;r<arguments.length;r++)log_s+=arguments[r];document.getElementById("info").innerHTML=log_s}!function(){if(!(gl=cv.getContext("webgl",{alpha:!1,premultipliedAlpha:!1,depth:!0,stencil:!1,antialias:!1})))return console.log("WebGL not supported, falling back on experimental-webgl"),void(gl=cv.getContext("experimental-webgl"));if(gl){t(),window.addEventListener("resize",t,!1),window.addEventListener("keydown",kbd,!1),window.addEventListener("keyup",kbu,!1),update=game_update,render=game_render,gl.enable(gl.CULL_FACE),gl.enable(gl.DEPTH_TEST);var r=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;if(game_init(),null===r)window.setInterval(r_update,1e3/60);else{var e=function(){r_update(),r(e)};r(e)}}else alert("Your browser does not support WebGL");function t(){cv.width=window.innerWidth,cv.height=window.innerHeight,console.log("w, h = ",cv.width,cv.height)}}();
